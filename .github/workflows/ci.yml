name: CI

on:
  push:
    branches: [main]
    tags: ['v*']
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          extensions: mbstring, intl, pdo_mysql, redis
      - name: Install Composer dependencies
        run: composer install --no-interaction --prefer-dist --no-progress
      - name: Install Node dependencies
        run: npm install
      - name: Build assets
        run: npm run build

  lint:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4
      - uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
      - name: Install Composer dependencies
        run: composer install --no-interaction --prefer-dist --no-progress
      - name: Run Pint
        run: vendor/bin/pint --test

  phpstan:
    runs-on: ubuntu-latest
    needs: build
    strategy:
      matrix:
        php: ['8.3', '8.4']
    steps:
      - uses: actions/checkout@v4
      - uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php }}
          extensions: mbstring, intl, pdo_mysql, redis
      - name: Install Composer dependencies
        run: composer install --no-interaction --prefer-dist --no-progress
      - name: Run PHPStan
        run: vendor/bin/phpstan analyse --no-progress

  pest:
    runs-on: ubuntu-latest
    needs: build
    strategy:
      matrix:
        php: ['8.3', '8.4']
        database: ['mysql', 'pgsql']
    services:
      database:
        image: ${{ matrix.database == 'mysql' && 'mysql:8.0' || 'postgres:15' }}
        env:
          MYSQL_DATABASE: cms
          MYSQL_USER: cms
          MYSQL_PASSWORD: secret
          MYSQL_ROOT_PASSWORD: secret
          POSTGRES_DB: cms
          POSTGRES_USER: cms
          POSTGRES_PASSWORD: secret
        options: >-
          --health-cmd="if [ '${{ matrix.database }}' = 'mysql' ]; then mysqladmin ping -h 127.0.0.1 -p$MYSQL_ROOT_PASSWORD -uroot; else pg_isready -h 127.0.0.1 -U $POSTGRES_USER; fi"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
    steps:
      - uses: actions/checkout@v4
      - uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php }}
          extensions: mbstring, intl, pdo_mysql, pdo_pgsql, redis
      - name: Install Composer dependencies
        run: composer install --no-interaction --prefer-dist --no-progress
      - name: Prepare Environment
        run: |
          cp .env.example .env
          php artisan key:generate
        env:
          APP_ENV: testing
          APP_DEBUG: 'false'
          DB_CONNECTION: ${{ matrix.database }}
          DB_HOST: database
          DB_DATABASE: cms
          DB_USERNAME: cms
          DB_PASSWORD: secret
          REDIS_HOST: 127.0.0.1
      - name: Prepare Database
        run: php artisan migrate --seed
        env:
          DB_CONNECTION: ${{ matrix.database }}
          DB_HOST: database
          DB_DATABASE: cms
          DB_USERNAME: cms
          DB_PASSWORD: secret
      - name: Run Pest
        run: vendor/bin/pest --ci
        env:
          DB_CONNECTION: ${{ matrix.database }}
          DB_HOST: database
          DB_DATABASE: cms
          DB_USERNAME: cms
          DB_PASSWORD: secret
      - name: Upload Test Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pest-${{ matrix.php }}-${{ matrix.database }}
          path: storage/logs
